# 基于图注意力网络的无人机语义通信资源分配
## Multi-Agent Reinforcement Learning with Graph Attention Networks for UAV Semantic Communication

---

## 📋 目录

1. 研究背景与问题
2. 系统架构
3. 核心算法
4. 技术实现
5. 实验结果
6. 工作总结与展望

---

## 1. 研究背景与问题

### 1.1 研究背景

- **无人机网络**：6个UAV在室内环境中协同工作
- **语义通信**：引入语义压缩比（ρ）优化通信效率
- **资源分配**：需要同时优化RB选择、功率控制和压缩比
- **多智能体协作**：UAV之间存在干扰和竞争关系

### 1.2 核心挑战

```
┌─────────────────────────────────────────┐
│  挑战1: 多智能体协作与竞争              │
│  - 6个UAV同时决策                       │
│  - 资源冲突避免                          │
│  - 需要显式建模智能体间关系              │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  挑战2: 动态环境                        │
│  - 信道状态快速变化                      │
│  - UAV位置动态移动                       │
│  - 需要实时适应                          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│  挑战3: 语义通信优化                    │
│  - 压缩比与准确度权衡                    │
│  - 能量效率最大化                        │
│  - 多目标优化                            │
└─────────────────────────────────────────┘
```

### 1.3 问题定义

**目标函数**：最大化语义能量效率（Semantic-EE）

```
Semantic-EE = Semantic Accuracy / Total Power Consumption
```

**决策变量**：
- RB选择（离散）：`[0, n_RB-1]`
- 传输功率（连续）：`[-bound, +bound]` dB
- 压缩比（连续）：`[0, 1]`

---

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    训练主循环                                │
│  main_PPO_AC.py                                             │
│  • 环境交互与数据收集                                        │
│  • 多进程并行训练                                            │
│  • 联邦学习聚合                                              │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│              PPO智能体网络                                   │
│  PPO_brain_AC.py                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  GAT编码器 (Graph Attention Network)                │   │
│  │  • 多层图注意力层                                      │   │
│  │  • 残差连接                                            │   │
│  │  • 多头注意力机制                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Actor网络 (策略网络)                                 │   │
│  │  • Power: 正态分布                                    │   │
│  │  • RB: 分类分布                                       │   │
│  │  • ρ: Beta分布                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Critic网络 (值函数)                                  │   │
│  │  • 节点级值估计                                        │   │
│  │  • GAE优势估计                                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    仿真环境                                  │
│  Environment_marl_indoor.py                                 │
│  • UAV位置与移动 (Gauss-Markov模型)                         │
│  • A2G信道模型                                              │
│  • 语义通信计算                                              │
│  • 奖励函数计算                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流

```
环境状态 → 节点特征提取 → GAT编码 → Actor/Critic → 动作选择
   ↑                                                      ↓
   └─────────────── 奖励反馈 ← 环境执行 ←───────────────┘
```

---

## 3. 核心算法

### 3.1 图注意力网络 (GAT)

#### 3.1.1 节点特征设计

每个UAV节点包含：
- **CSI快衰落**：`[n_RB]` - 瞬时信道状态
- **CSI慢衰落**：`[n_RB]` - 路径损耗和阴影
- **位置信息**：`[3]` - (x, y, z)坐标
- **成功标志**：`[1]` - 上次传输是否成功
- **Episode进度**：`[1]` - 训练进度

**总维度**：`n_RB × 2 + 3 + 2 = 25` (n_RB=10时)

#### 3.1.2 邻接矩阵构建

```python
adj_matrix[i, j] = 1 if distance(i, j) < comm_range else 0
```

- 基于通信距离（默认500m）
- 动态更新（UAV移动）

#### 3.1.3 注意力机制

```
e_ij = LeakyReLU(W_a^T [W_h h_i || W_h h_j])
α_ij = softmax_j(e_ij)
h_i' = σ(Σ_j α_ij W_h h_j)
```

**多头注意力**：
- 默认4个头
- 每个头学习不同的关系
- 最终拼接所有头的输出

#### 3.1.4 残差连接

```python
x_output = activation(x_gat + x_input)  # 残差连接
```

- 提升训练稳定性
- 缓解梯度消失
- 参考Edge-GAT实现

### 3.2 多智能体PPO (MAPPO)

#### 3.2.1 PPO损失函数

```
L_total = L_clip_power + L_clip_RB + L_clip_rho - c1·L_vf + c2·S
```

**各组件**：
- `L_clip_power`: 功率动作的PPO裁剪损失
- `L_clip_RB`: RB选择的PPO裁剪损失  
- `L_clip_rho`: 压缩比的PPO裁剪损失
- `L_vf`: 值函数损失（Critic）
- `S`: 策略熵（鼓励探索）

#### 3.2.2 动作分布

| 动作类型 | 分布类型 | 参数 | 范围 |
|---------|---------|------|------|
| Power | 正态分布 | μ, σ | [-bound, +bound] |
| RB | 分类分布 | softmax(logits) | [0, n_RB-1] |
| ρ | Beta分布 | α, β | [0, 1] |

#### 3.2.3 GAE优势估计

```python
# 为每个agent单独计算GAE
for agent_idx in range(n_veh):
    delta = reward + gamma * v_next - v
    gae = compute_gae(delta)  # 反向计算
```

### 3.3 语义通信模型

#### 3.3.1 语义准确度

```
A(ρ, SINR) = A_max · (1 - exp(-β·ρ)) · log(1 + SINR) / log(1 + max_SINR)
```

- `A_max`: 最大准确度（默认1.0）
- `β`: 压缩比敏感度（默认2.0）
- `ρ`: 压缩比 [0, 1]
- `SINR`: 信噪比

#### 3.3.2 语义能量效率

```
Semantic-EE = A(ρ, SINR) / Total_Power
```

**总功率**：
- 传输功率（线性）
- 电路功率（固定）

---

## 4. 技术实现

### 4.1 关键技术点

#### 4.1.1 GAT批处理

```python
# 使用tf.map_fn处理批次中的每个图
def process_graph(idx):
    node_feat = node_features[idx]  # [n_veh, feature_dim]
    adj = adj_matrix[idx]            # [n_veh, n_veh]
    return multi_layer_gat(node_feat, adj)

gat_outputs = tf.map_fn(process_graph, indices, ...)
```

#### 4.1.2 节点选择机制

```python
# 训练时，每个agent只使用自己的节点输出
power_prob = power_prob_all[:, agent_idx]  # 不取mean
v_pred = v_all[:, agent_idx]              # 节点级值估计
```

#### 4.1.3 数值稳定性

```python
# 防止NaN和梯度爆炸
- 梯度裁剪 (clip_by_norm, 0.5)
- 值函数裁剪 (clip_by_value, -50, 50)
- Ratio裁剪 (clip_by_value, 1e-6, 1e6)
- NaN替换 (tf.where(tf.is_finite(...)))
```

#### 4.1.4 Reward归一化

```python
# 避免除零错误
if rewards.std() > 1e-8:
    rewards = (rewards - rewards.mean()) / rewards.std()
# 否则保持原值
```

### 4.2 联邦学习聚合

```python
# 简单平均加权（uniform weights）
for param in all_params:
    avg_param = mean([agent_i.param for i in range(n_veh)])
    assign_to_all_agents(avg_param)
```

### 4.3 训练流程

```
1. 初始化环境
   ↓
2. 收集轨迹数据
   - 并行执行多个episode
   - 存储状态、动作、奖励
   ↓
3. 计算GAE优势
   ↓
4. 采样批次数据
   ↓
5. 训练每个agent
   - GAT编码
   - 计算PPO损失
   - 反向传播
   ↓
6. 联邦学习聚合
   ↓
7. 更新old网络参数
   ↓
8. 重复步骤2-7
```

---

## 5. 实验结果

### 5.1 环境配置

| 参数 | 值 |
|------|-----|
| UAV数量 | 6 |
| RB数量 | 10 |
| 环境大小 | 25m × 25m |
| UAV高度 | 1.5m |
| 通信范围 | 500m |
| 学习率 | 1e-6 |
| 熵权重 | 0.01 |

### 5.2 关键修复

#### 修复1: GAE计算
- **问题**：无法处理2D输入 `[T, n_veh]`
- **解决**：为每个agent单独计算GAE

#### 修复2: Reward归一化
- **问题**：所有reward相同时归一化为0
- **解决**：检查std，避免除零

#### 修复3: 节点选择
- **问题**：对所有节点取mean导致信息丢失
- **解决**：每个agent使用自己的节点输出

#### 修复4: 数值稳定性
- **问题**：NaN和梯度爆炸
- **解决**：梯度裁剪、值裁剪、NaN替换

### 5.3 当前状态

**已实现功能**：
- ✅ GAT编码器（多层+残差）
- ✅ 多动作头（Power, RB, ρ）
- ✅ 节点级值函数
- ✅ GAE优势估计
- ✅ 联邦学习聚合
- ✅ 数值稳定性处理

**待解决问题**：
- ⚠️ Actor参数（mu, sigma）出现NaN
- ⚠️ Entropy为0
- ⚠️ Policy loss为0

**可能原因**：
- GAT编码器输出异常
- Actor网络初始化问题
- 需要进一步调试

---

## 6. 工作总结与展望

### 6.1 已完成工作

1. **架构设计**
   - 集成GAT到MAPPO框架
   - 设计节点特征和邻接矩阵
   - 实现多动作头输出

2. **算法实现**
   - GAT编码器（多层+残差）
   - PPO损失计算
   - GAE优势估计
   - 联邦学习聚合

3. **问题修复**
   - GAE计算修复
   - Reward归一化修复
   - 节点选择机制
   - 数值稳定性处理

### 6.2 技术亮点

- **图结构建模**：显式建模UAV间关系
- **注意力机制**：自适应学习重要邻居
- **残差连接**：提升训练稳定性
- **多动作分布**：灵活的动作空间设计
- **语义通信**：引入压缩比优化

### 6.3 下一步工作

1. **调试Actor网络**
   - 检查GAT编码器输出
   - 修复mu/sigma的NaN问题
   - 恢复Entropy计算

2. **性能优化**
   - 调整超参数
   - 优化网络结构
   - 提升训练效率

3. **实验验证**
   - 对比GAT vs MLP
   - 评估语义通信效果
   - 分析收敛性能

4. **功能扩展**
   - 引入边特征（Edge-GAT）
   - 支持更大规模网络
   - 动态图结构

### 6.4 预期效果

- **协作能力**：GAT帮助UAV学习协作策略
- **收敛速度**：图结构信息加速学习
- **性能提升**：语义通信优化提升效率
- **泛化能力**：图结构支持不同网络拓扑

---

## 附录：代码结构

```
GAT_RA/
├── main_PPO_AC.py          # 训练主循环
├── PPO_brain_AC.py         # PPO智能体（GAT+MAPPO）
├── Environment_marl_indoor.py  # 仿真环境
├── arguments.py            # 参数配置
└── logs/                   # 训练日志
    └── tensorboard/        # TensorBoard日志
```

---

## 谢谢！

**问题与讨论**

---

## 参考实现

- **Edge-GAT**: 边特征和残差连接
- **GraphSAGE**: 邻居采样和聚合
- **原始PPO**: 最小化修改原则

